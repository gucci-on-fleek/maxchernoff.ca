# Source Code for maxchernoff.ca
# https://github.com/gucci-on-fleek/maxchernoff.ca
# SPDX-License-Identifier: GPL-3.0+
# SPDX-FileCopyrightText: 2019-2020 Max Mazurov <fox.cpp@disroot.org>, Maddy Mail Server contributors
# SPDX-FileCopyrightText: 2024 Max Chernoff

$(hostname) = noreply.maxchernoff.ca
$(primary_domain) = maxchernoff.ca
$(local_domains) = $(primary_domain)

tls off

# SMTP endpoints + message routing
hostname maxchernoff.ca

submission tcp://0.0.0.0:587 {
    auth pass_table {
        table static {
            entry test "argon2:2:1024:1:xMKlMSgWeWHTEeYVF7KhjA==:Mib3g6u59j1juXilQhtCiDDLxFD5w5C/8hWIUWDQnosoxXccbx4Mjcjiu0n4PM4linp9EXhGGynKy+r+cSZi3w=="
        }
    }

    modify {
        dkim $(hostname) default
    }

    deliver_to &remote_queue
}

target.queue remote_queue {
    target &outbound_delivery

    autogenerated_msg_domain $(primary_domain)
    bounce {
        destination postmaster $(local_domains) {
            deliver_to &outbound_delivery
        }
        default_destination {
            reject 550 5.0.0 "Refusing to send DSNs to non-local addresses"
        }
    }
}

target.remote outbound_delivery {
    limits {
        # Up to 1 msgs/sec across max. 10 SMTP connections
        # for each recipient domain.
        destination rate 1 1s
        destination concurrency 10
    }
    mx_auth {
        dane
        mtasts {
            cache fs
            fs_dir mtasts_cache/
        }
        local_policy {
            min_tls_level encrypted
            min_mx_level none
        }
    }
}

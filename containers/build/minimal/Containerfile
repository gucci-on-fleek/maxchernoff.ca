# Source Code for maxchernoff.ca
# https://github.com/gucci-on-fleek/maxchernoff.ca
# SPDX-License-Identifier: MPL-2.0+ OR CC-BY-SA-4.0+
# SPDX-FileCopyrightText: 2024 Max Chernoff

# Base image
FROM registry.fedoraproject.org/fedora-minimal:41 AS builder

# Install rpm-ostree
RUN dnf5 install \
    --assumeyes \
    --nodocs \
    --setopt=install_weak_deps=false \
    --setopt=keepcache=true \
    --use-host-config \
    rpm-ostree

# Add the files
COPY ["container-build.sh", "/usr/local/sbin/"]

# Run the build script
RUN /usr/local/sbin/container-build.sh

# Pull in the created image
FROM oci-archive:./image.tar

# Remove the image tarball
RUN --mount=type=bind,from=builder,src=/root/,target=/root/ \
    rm /var/out/image.tar

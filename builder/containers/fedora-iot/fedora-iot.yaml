# Source Code for maxchernoff.ca
# https://github.com/gucci-on-fleek/maxchernoff.ca
# SPDX-License-Identifier: MPL-2.0+ OR CC-BY-SA-4.0+
# SPDX-FileCopyrightText: 2026 Max Chernoff

# Use the newer treefile defaults
edition: "2024"

# What to call our container
ref: maxchernoff.ca/fedora-iot-base
mutate-os-release: "${releasever}"
automatic-version-prefix: "${releasever}.<date:%Y%m%d>"

# Use the host's Fedora repos
releasever: "!!fedora.version!!"
repos:
  - fedora
  - updates
  # - updates-testing

# Keep the security attributes
selinux: true
# ima: true # TODO: See https://discussion.fedoraproject.org/t/150494
readonly-executables: true

# Make the RPM database reproducible
rpmdb-normalize: true

# Don't generate an initramfs
# no-initramfs: true  # TODO: not released yet

# Don't create an /etc/machine-id file
machineid-compat: false

# Global package installation options
recommends: false
documentation: true

# Set the installed locales
install-langs:
  - en_CA

# /etc/passwd settings
etc-group-members:
  - wheel
ignore-removed-users:
  - root
ignore-removed-groups:
  - root

# Packages to install
packages:
  - acl # getfacl/setfacl
  - audit-rules # auditctl
  - authselect # PAM configuration
  - bees # Btrfs deduplication
  - bootc
  - borgbackup
  - btrfs-progs # /usr/bin/btrfs
  - btrfsmaintenance
  - busybox
  - chrony
  - curl
  - dnf5
  - dosfstools # fsck for the EFI partition
  - dracut-config-generic # Creates a non-host-specific initramfs
  - efibootmgr
  - fedora-release-iot
  - firewalld
  - fish
  - fwupd-efi
  - git-core
  - glibc-langpack-en
  - glibc-minimal-langpack
  - gnupg2 # GPG
  - htop
  - iproute # /usr/bin/ip
  - iputils # ping, etc.
  - kernel
  - less
  - man-db # man pages
  - microcode_ctl
  - node-exporter  # Prometheus metrics for the entire system
  - nss-altfiles # Also allows /usr/etc/passwd
  - openssh-clients
  - openssh-server
  - perl-File-Find # Needed for TeX Live
  - perl-interpreter # Needed for TeX Live
  - perl-LWP-Protocol-https # Recommended for TeX Live
  - podman
  - policycoreutils-python-utils # semanage
  - prometheus-podman-exporter  # Prometheus metrics for Podman containers
  - python3-cryptography
  - python3-pystemd
  - qemu-guest-agent # Recommended for a VM guest
  - ripgrep
  - selinux-policy-targeted
  - setools-console
  - snapper
  - strace
  - sudo
  - systemd
  - systemd-boot-unsigned
  - systemd-container # systemd-nspawn
  - systemd-journal-remote # For journald remote logging
  - systemd-networkd
  - systemd-resolved
  - tar # Needed for TeX Live
  - tmux
  - traceroute
  - udica
  - vim-enhanced
  - xz # Needed for TeX Live
  - zram-generator

add-files:
  - ["files/image-minimizer.py", "/usr/bin/image-minimizer"]
  - ["files/image-minimize.txt", "/etc/tmp/image-minimize.txt"]
  - ["files/local-required-fallbacks.cil", "/etc/tmp/local-required-fallbacks.cil"]
  - ["files/console-colors.sh", "/usr/bin/console-colors.sh"]
  - ["files/00-fedora-iot.toml", "/usr/lib/bootc/install/00-fedora-iot.toml"]
  - ["files/prepare-root.conf", "/usr/lib/ostree/prepare-root.conf"]
  - ["files/composefs-module-setup.sh", "/usr/lib/dracut/modules.d/37composefs/module-setup.sh"]
  - ["files/composefs-setup-root.service", "/usr/lib/dracut/modules.d/37composefs/composefs-setup-root.service"]
  - ["files/00-default-units.preset", "/etc/systemd/system-preset/00-default-units.preset"]
  - ["files/fix-etc.service", "/usr/lib/systemd/system/fix-etc.service"]

postprocess:
  - |
    set -euo pipefail

    # From https://pagure.io/fedora-iot/ostree/blob/f41/f/treecompose-post.sh
    rm -rf /etc/systemd/system/*
    systemctl preset-all
    rm -rf /etc/systemd/user/*
    systemctl --user --global preset-all

    # Set SELinux context for prometheus-podman-exporter
    semanage fcontext --add '/usr/bin/prometheus-podman-exporter' --type container_runtime_exec_t

    # A horrible hack to prevent dracut from running
    mv /usr/bin/dracut /usr/libexec/dracut
    printf '#!/usr/bin/bash\ntouch /tmp/initramfs.img' > /usr/bin/dracut
    chmod a+x /usr/bin/dracut

    # Run image-minimizer
    INSTALL_ROOT=/ /usr/bin/image-minimizer /etc/tmp/image-minimize.txt

    # Rebuild the SELinux modules
    semanage user --modify user_u --range s0-s0:c0.c1023
    semanage login --modify --seuser user_u --range 's0-s0:c0.c1023' __default__
    semodule --install=/etc/tmp/local-required-fallbacks.cil

    # Fix all permissions
    restorecon -RF / || true

    # Remove the temporary files
    rm -rf /etc/tmp/
